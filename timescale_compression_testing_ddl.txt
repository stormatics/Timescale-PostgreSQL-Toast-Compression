drop table hit_uncompressed;
CREATE TABLE hit_uncompressed
(
    WatchID BIGINT NOT NULL,
    JavaEnable SMALLINT NOT NULL,
    Title TEXT NOT NULL,
    GoodEvent SMALLINT NOT NULL,
    EventTime TIMESTAMPTZ NOT NULL,
    EventDate Date NOT NULL,
    CounterID INTEGER NOT NULL,
    ClientIP INTEGER NOT NULL,
    RegionID INTEGER NOT NULL,
    UserID BIGINT NOT NULL,
    CounterClass SMALLINT NOT NULL,
    OS SMALLINT NOT NULL,
    UserAgent SMALLINT NOT NULL,
    URL TEXT NOT NULL,
    Referer TEXT NOT NULL,
    IsRefresh SMALLINT NOT NULL,
    RefererCategoryID SMALLINT NOT NULL,
    RefererRegionID INTEGER NOT NULL,
    URLCategoryID SMALLINT NOT NULL,
    URLRegionID INTEGER NOT NULL,
    ResolutionWidth SMALLINT NOT NULL,
    ResolutionHeight SMALLINT NOT NULL,
    ResolutionDepth SMALLINT NOT NULL,
    FlashMajor SMALLINT NOT NULL,
    FlashMinor SMALLINT NOT NULL,
    FlashMinor2 TEXT NOT NULL,
    NetMajor SMALLINT NOT NULL,
    NetMinor SMALLINT NOT NULL,
    UserAgentMajor SMALLINT NOT NULL,
    UserAgentMinor TEXT NOT NULL,
    CookieEnable SMALLINT NOT NULL,
    JavascriptEnable SMALLINT NOT NULL,
    IsMobile SMALLINT NOT NULL,
    MobilePhone SMALLINT NOT NULL,
    MobilePhoneModel TEXT NOT NULL,
    Params TEXT NOT NULL,
    IPNetworkID INTEGER NOT NULL,
    TraficSourceID SMALLINT NOT NULL,
    SearchEngineID SMALLINT NOT NULL,
    SearchPhrase TEXT NOT NULL,
    AdvEngineID SMALLINT NOT NULL,
    IsArtifical SMALLINT NOT NULL,
    WindowClientWidth SMALLINT NOT NULL,
    WindowClientHeight SMALLINT NOT NULL,
    ClientTimeZone SMALLINT NOT NULL,
    ClientEventTime TIMESTAMPTZ NOT NULL,
    SilverlightVersion1 SMALLINT NOT NULL,
    SilverlightVersion2 SMALLINT NOT NULL,
    SilverlightVersion3 INTEGER NOT NULL,
    SilverlightVersion4 SMALLINT NOT NULL,
    PageCharset TEXT NOT NULL,
    CodeVersion INTEGER NOT NULL,
    IsLink SMALLINT NOT NULL,
    IsDownload SMALLINT NOT NULL,
    IsNotBounce SMALLINT NOT NULL,
    FUniqID BIGINT NOT NULL,
    OriginalURL TEXT NOT NULL,
    HID INTEGER NOT NULL,
    IsOldCounter SMALLINT NOT NULL,
    IsEvent SMALLINT NOT NULL,
    IsParameter SMALLINT NOT NULL,
    DontCountHits SMALLINT NOT NULL,
    WithHash SMALLINT NOT NULL,
    HitColor CHAR NOT NULL,
    LocalEventTime TIMESTAMPTZ NOT NULL,
    Age SMALLINT NOT NULL,
    Sex SMALLINT NOT NULL,
    Income SMALLINT NOT NULL,
    Interests SMALLINT NOT NULL,
    Robotness SMALLINT NOT NULL,
    RemoteIP INTEGER NOT NULL,
    WindowName INTEGER NOT NULL,
    OpenerName INTEGER NOT NULL,
    HistoryLength SMALLINT NOT NULL,
    BrowserLanguage TEXT NOT NULL,
    BrowserCountry TEXT NOT NULL,
    SocialNetwork TEXT NOT NULL,
    SocialAction TEXT NOT NULL,
    HTTPError SMALLINT NOT NULL,
    SendTiming INTEGER NOT NULL,
    DNSTiming INTEGER NOT NULL,
    ConnectTiming INTEGER NOT NULL,
    ResponseStartTiming INTEGER NOT NULL,
    ResponseEndTiming INTEGER NOT NULL,
    FetchTiming INTEGER NOT NULL,
    SocialSourceNetworkID SMALLINT NOT NULL,
    SocialSourcePage TEXT NOT NULL,
    ParamPrice BIGINT NOT NULL,
    ParamOrderID TEXT NOT NULL,
    ParamCurrency TEXT NOT NULL,
    ParamCurrencyID SMALLINT NOT NULL,
    OpenstatServiceName TEXT NOT NULL,
    OpenstatCampaignID TEXT NOT NULL,
    OpenstatAdID TEXT NOT NULL,
    OpenstatSourceID TEXT NOT NULL,
    UTMSource TEXT NOT NULL,
    UTMMedium TEXT NOT NULL,
    UTMCampaign TEXT NOT NULL,
    UTMContent TEXT NOT NULL,
    UTMTerm TEXT NOT NULL,
    FromTag TEXT NOT NULL,
    HasGCLID SMALLINT NOT NULL,
    RefererHash BIGINT NOT NULL,
    URLHash BIGINT NOT NULL,
    CLID INTEGER NOT NULL,
	payload jsonb NOT NULL
);


ALTER TABLE hit_uncompressed ALTER COLUMN FromTag SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN UTMTerm SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN UTMContent SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN UTMCampaign SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN UTMMedium SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN UTMSource SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN OpenstatSourceID SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN OpenstatAdID SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN OpenstatCampaignID SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN OpenstatServiceName SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN ParamCurrency SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN ParamOrderID SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN SocialSourcePage SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN SocialAction SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN SocialNetwork SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN BrowserCountry SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN BrowserLanguage SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN HitColor SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN OriginalURL SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN PageCharset SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN SearchPhrase SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN MobilePhoneModel SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN UserAgentMinor SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN FlashMinor2 SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN Referer SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN URL SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN Title SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN Params SET STORAGE external;
ALTER TABLE hit_uncompressed ALTER COLUMN payload SET STORAGE external;


create index idx_hit_uncompressed_eventtime on hit_uncompressed(eventtime DESC);
CREATE INDEX idx_hit_uncompressed_regid  on hit_uncompressed (RegionID);
CREATE INDEX idx_hit_uncompressed_cid on hit_uncompressed (counterid);
CREATE INDEX idx_hit_uncompressed_refresh on hit_uncompressed (isrefresh, dontcounthits) where isrefresh <> 0 and dontcounthit <> 0;
CREATE INDEX idx_hit_uncompressed_userid on hit_uncompressed (userid);
CREATE INDEX idx_hit_uncompressed_regionuser on hit_uncompressed (RegionID,UserID);
CREATE INDEX idx_hit_uncompressed_search2 on hit_uncompressed (searchphrase) WHERE searchphrase <> ''::text;
CREATE INDEX idx_hit_uncompressed_trgm_idx_url ON hit_uncompressed USING gin (url gin_trgm_ops);


Analyze hit_uncompressed;


----
Load dataset into hit table

postgres@ip-172-31-76-243:~$ psql -c '\timing' -c "COPY hit_uncompressed from '/home/postgres/hits.tsv'"
Timing is on.
COPY 99997497
Time: 2081240.739 ms (34:41.241)

----

Create proper indexes for running queries

postgres@ip-172-31-76-243:~$ set maintenance_work_mem='4GB';
SET





SELECT
    c1.relname,
    pg_size_pretty(pg_relation_size(c1.relname::regclass)) AS table_size,
pg_size_pretty(pg_indexes_size(c1.relname::regclass)) AS table_index_size,
    c2.relname AS toast_relname,
    pg_size_pretty(pg_relation_size(('pg_toast.' || c2.relname)::regclass)) AS toast_size,
pg_size_pretty(pg_relation_size(('pg_toast.' || c2.relname || '_index')::regclass)) AS toast_index_size
FROM
    pg_class c1
    JOIN pg_class c2 ON c1.reltoastrelid = c2.oid
WHERE
    c1.relname = 'hit_uncompressed'
    AND c1.relkind = 'r';


     relname      | table_size | table_index_size | toast_relname  | toast_size | toast_index_size
------------------+------------+------------------+----------------+------------+------------------
 hit_uncompressed | 64 GB      | 15 GB            | pg_toast_16393 | 1945 MB    | 31 MB
(1 row)



Queries to run:

1: SELECT UserID, extract(day FROM EventTime) AS m, SearchPhrase,URL, COUNT(*) FROM hits GROUP BY UserID, m, SearchPhrase,URL where eventtime >= '2013-07-24' and search_phrase <> '' and URL <> '' ORDER BY COUNT(*) DESC LIMIT 10;

check hourly webpage view counts 

2: SELECT
  EXTRACT(hour from eventtime) as hours,
  COUNT(*) as PageViews
FROM hit
WHERE eventtime > '2013-07-31 00:00:00' 
GROUP BY hours;

3: SELECT time_bucket('1 hour', eventtime) AS hour, count(*) as PageViews -> extra for timescale
FROM hit
WHERE eventtime > '2013-07-31 00:00:00'
GROUP BY hour
ORDER BY hour DESC;

4: SELECT RegionID, , COUNT(*) AS PageViews FROM hits WHERE CounterID = 62 AND eventtime >= '2013-07-24' AND eventtime <= '2013-07-31' AND IsRefresh = 0 AND URL URL<> '' GROUP BY RegionID, URL ORDER BY PageViews DESC LIMIT 10;


----------------------------------------


We are using toast storage here and no compression is performed on the table.



drop table hit_compressed_lz4;
CREATE TABLE hit_compressed_lz4
(
    WatchID BIGINT NOT NULL,
    JavaEnable SMALLINT NOT NULL,
    Title TEXT COMPRESSION LZ4 NOT NULL ,
    GoodEvent SMALLINT NOT NULL,
    EventTime TIMESTAMPTZ NOT NULL,
    EventDate Date NOT NULL,
    CounterID INTEGER NOT NULL,
    ClientIP INTEGER NOT NULL,
    RegionID INTEGER NOT NULL,
    UserID BIGINT NOT NULL,
    CounterClass SMALLINT NOT NULL,
    OS SMALLINT NOT NULL,
    UserAgent SMALLINT NOT NULL,
    URL TEXT COMPRESSION LZ4 NOT NULL,
    Referer TEXT COMPRESSION LZ4 NOT NULL,
    IsRefresh SMALLINT NOT NULL,
    RefererCategoryID SMALLINT NOT NULL,
    RefererRegionID INTEGER NOT NULL,
    URLCategoryID SMALLINT NOT NULL,
    URLRegionID INTEGER NOT NULL,
    ResolutionWidth SMALLINT NOT NULL,
    ResolutionHeight SMALLINT NOT NULL,
    ResolutionDepth SMALLINT NOT NULL,
    FlashMajor SMALLINT NOT NULL,
    FlashMinor SMALLINT NOT NULL,
    FlashMinor2 TEXT COMPRESSION LZ4 NOT NULL,
    NetMajor SMALLINT NOT NULL,
    NetMinor SMALLINT NOT NULL,
    UserAgentMajor SMALLINT NOT NULL,
    UserAgentMinor TEXT COMPRESSION LZ4 NOT NULL,
    CookieEnable SMALLINT NOT NULL,
    JavascriptEnable SMALLINT NOT NULL,
    IsMobile SMALLINT NOT NULL,
    MobilePhone SMALLINT NOT NULL,
    MobilePhoneModel TEXT COMPRESSION LZ4 NOT NULL,
    Params TEXT COMPRESSION LZ4 NOT NULL,
    IPNetworkID INTEGER NOT NULL,
    TraficSourceID SMALLINT NOT NULL,
    SearchEngineID SMALLINT NOT NULL,
    SearchPhrase TEXT COMPRESSION LZ4 NOT NULL,
    AdvEngineID SMALLINT NOT NULL,
    IsArtifical SMALLINT NOT NULL,
    WindowClientWidth SMALLINT NOT NULL,
    WindowClientHeight SMALLINT NOT NULL,
    ClientTimeZone SMALLINT NOT NULL,
    ClientEventTime TIMESTAMPTZ NOT NULL,
    SilverlightVersion1 SMALLINT NOT NULL,
    SilverlightVersion2 SMALLINT NOT NULL,
    SilverlightVersion3 INTEGER NOT NULL,
    SilverlightVersion4 SMALLINT NOT NULL,
    PageCharset TEXT COMPRESSION LZ4 NOT NULL,
    CodeVersion INTEGER NOT NULL,
    IsLink SMALLINT NOT NULL,
    IsDownload SMALLINT NOT NULL,
    IsNotBounce SMALLINT NOT NULL,
    FUniqID BIGINT NOT NULL,
    OriginalURL TEXT COMPRESSION LZ4 NOT NULL,
    HID INTEGER NOT NULL,
    IsOldCounter SMALLINT NOT NULL,
    IsEvent SMALLINT NOT NULL,
    IsParameter SMALLINT NOT NULL,
    DontCountHits SMALLINT NOT NULL,
    WithHash SMALLINT NOT NULL,
    HitColor CHAR COMPRESSION LZ4 NOT NULL,
    LocalEventTime TIMESTAMPTZ NOT NULL,
    Age SMALLINT NOT NULL,
    Sex SMALLINT NOT NULL,
    Income SMALLINT NOT NULL,
    Interests SMALLINT NOT NULL,
    Robotness SMALLINT NOT NULL,
    RemoteIP INTEGER NOT NULL,
    WindowName INTEGER NOT NULL,
    OpenerName INTEGER NOT NULL,
    HistoryLength SMALLINT NOT NULL,
    BrowserLanguage TEXT COMPRESSION LZ4 NOT NULL,
    BrowserCountry TEXT COMPRESSION LZ4 NOT NULL,
    SocialNetwork TEXT COMPRESSION LZ4 NOT NULL,
    SocialAction TEXT COMPRESSION LZ4 NOT NULL,
    HTTPError SMALLINT NOT NULL,
    SendTiming INTEGER NOT NULL,
    DNSTiming INTEGER NOT NULL,
    ConnectTiming INTEGER NOT NULL,
    ResponseStartTiming INTEGER NOT NULL,
    ResponseEndTiming INTEGER NOT NULL,
    FetchTiming INTEGER NOT NULL,
    SocialSourceNetworkID SMALLINT NOT NULL,
    SocialSourcePage TEXT COMPRESSION LZ4 NOT NULL,
    ParamPrice BIGINT NOT NULL,
    ParamOrderID TEXT COMPRESSION LZ4 NOT NULL,
    ParamCurrency TEXT COMPRESSION LZ4 NOT NULL,
    ParamCurrencyID SMALLINT NOT NULL,
    OpenstatServiceName TEXT COMPRESSION LZ4 NOT NULL,
    OpenstatCampaignID TEXT COMPRESSION LZ4 NOT NULL,
    OpenstatAdID TEXT COMPRESSION LZ4 NOT NULL,
    OpenstatSourceID TEXT COMPRESSION LZ4 NOT NULL,
    UTMSource TEXT COMPRESSION LZ4 NOT NULL,
    UTMMedium TEXT COMPRESSION LZ4 NOT NULL,
    UTMCampaign TEXT COMPRESSION LZ4 NOT NULL,
    UTMContent TEXT COMPRESSION LZ4 NOT NULL,
    UTMTerm TEXT COMPRESSION LZ4 NOT NULL,
    FromTag TEXT COMPRESSION LZ4 NOT NULL,
    HasGCLID SMALLINT NOT NULL,
    RefererHash BIGINT NOT NULL,
    URLHash BIGINT NOT NULL,
    CLID INTEGER NOT NULL,
	payload jsonb COMPRESSION LZ4 NOT NULL
);

ALTER TABLE hit_compressed_lz4 ALTER COLUMN FromTag SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN UTMTerm SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN UTMContent SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN UTMCampaign SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN UTMMedium SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN UTMSource SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN OpenstatSourceID SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN OpenstatAdID SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN OpenstatCampaignID SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN OpenstatServiceName SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN ParamCurrency SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN ParamOrderID SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN SocialSourcePage SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN SocialAction SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN SocialNetwork SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN BrowserCountry SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN BrowserLanguage SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN HitColor SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN OriginalURL SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN PageCharset SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN SearchPhrase SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN MobilePhoneModel SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN UserAgentMinor SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN FlashMinor2 SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN Referer SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN URL SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN Title SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN Params SET STORAGE main;
ALTER TABLE hit_compressed_lz4 ALTER COLUMN payload SET STORAGE main;



create index idx_hit_compressed_eventtime on hit_compressed_lz4(eventtime DESC);
CREATE INDEX idx_hit_compressed_regid  on hit_compressed_lz4 (RegionID);
CREATE INDEX idx_hit_compressed_cid on hit_compressed_lz4 (counterid);
CREATE INDEX idx_hit_compressed_refresh on hit_compressed_lz4 (isrefresh, dontcounthits) where isrefresh <> 0 and dontcounthit <> 0;
CREATE INDEX idx_hit_compressed_userid on hit_compressed_lz4 (userid);
CREATE INDEX idx_hit_compressed_regionuser on hit_compressed_lz4 (RegionID,UserID);
CREATE INDEX idx_hit_compressed_search2 on hit_compressed_lz4 (searchphrase) WHERE searchphrase <> ''::text;
CREATE INDEX idx_hit_compressed_trgm_idx_url ON hit_compressed_lz4 USING gin (url gin_trgm_ops);


Analyze hit_compressed;



postgres@ip-172-31-76-243:~$ psql -c '\timing' -c "COPY hit_compressed from '/home/postgres/hits.tsv'"
Timing is on.
COPY 99997497
Time: 2827834.725 ms (47:07.835)

    relname     | table_size | table_index_size | toast_relname  | toast_size | toast_index_size
----------------+------------+------------------+----------------+------------+------------------
 hit_compressed | 65 GB      | 1548 MB          | pg_toast_16388 | 0 bytes    | 8192 bytes


No toast space is used here.





drop table hit_compressed_pglz;
CREATE TABLE hit_compressed_pglz
(
    WatchID BIGINT NOT NULL,
    JavaEnable SMALLINT NOT NULL,
    Title TEXT  NOT NULL ,
    GoodEvent SMALLINT NOT NULL,
    EventTime TIMESTAMPTZ NOT NULL,
    EventDate Date NOT NULL,
    CounterID INTEGER NOT NULL,
    ClientIP INTEGER NOT NULL,
    RegionID INTEGER NOT NULL,
    UserID BIGINT NOT NULL,
    CounterClass SMALLINT NOT NULL,
    OS SMALLINT NOT NULL,
    UserAgent SMALLINT NOT NULL,
    URL TEXT  NOT NULL,
    Referer TEXT  NOT NULL,
    IsRefresh SMALLINT NOT NULL,
    RefererCategoryID SMALLINT NOT NULL,
    RefererRegionID INTEGER NOT NULL,
    URLCategoryID SMALLINT NOT NULL,
    URLRegionID INTEGER NOT NULL,
    ResolutionWidth SMALLINT NOT NULL,
    ResolutionHeight SMALLINT NOT NULL,
    ResolutionDepth SMALLINT NOT NULL,
    FlashMajor SMALLINT NOT NULL,
    FlashMinor SMALLINT NOT NULL,
    FlashMinor2 TEXT  NOT NULL,
    NetMajor SMALLINT NOT NULL,
    NetMinor SMALLINT NOT NULL,
    UserAgentMajor SMALLINT NOT NULL,
    UserAgentMinor TEXT  NOT NULL,
    CookieEnable SMALLINT NOT NULL,
    JavascriptEnable SMALLINT NOT NULL,
    IsMobile SMALLINT NOT NULL,
    MobilePhone SMALLINT NOT NULL,
    MobilePhoneModel TEXT  NOT NULL,
    Params TEXT  NOT NULL,
    IPNetworkID INTEGER NOT NULL,
    TraficSourceID SMALLINT NOT NULL,
    SearchEngineID SMALLINT NOT NULL,
    SearchPhrase TEXT  NOT NULL,
    AdvEngineID SMALLINT NOT NULL,
    IsArtifical SMALLINT NOT NULL,
    WindowClientWidth SMALLINT NOT NULL,
    WindowClientHeight SMALLINT NOT NULL,
    ClientTimeZone SMALLINT NOT NULL,
    ClientEventTime TIMESTAMPTZ NOT NULL,
    SilverlightVersion1 SMALLINT NOT NULL,
    SilverlightVersion2 SMALLINT NOT NULL,
    SilverlightVersion3 INTEGER NOT NULL,
    SilverlightVersion4 SMALLINT NOT NULL,
    PageCharset TEXT  NOT NULL,
    CodeVersion INTEGER NOT NULL,
    IsLink SMALLINT NOT NULL,
    IsDownload SMALLINT NOT NULL,
    IsNotBounce SMALLINT NOT NULL,
    FUniqID BIGINT NOT NULL,
    OriginalURL TEXT  NOT NULL,
    HID INTEGER NOT NULL,
    IsOldCounter SMALLINT NOT NULL,
    IsEvent SMALLINT NOT NULL,
    IsParameter SMALLINT NOT NULL,
    DontCountHits SMALLINT NOT NULL,
    WithHash SMALLINT NOT NULL,
    HitColor CHAR  NOT NULL,
    LocalEventTime TIMESTAMPTZ NOT NULL,
    Age SMALLINT NOT NULL,
    Sex SMALLINT NOT NULL,
    Income SMALLINT NOT NULL,
    Interests SMALLINT NOT NULL,
    Robotness SMALLINT NOT NULL,
    RemoteIP INTEGER NOT NULL,
    WindowName INTEGER NOT NULL,
    OpenerName INTEGER NOT NULL,
    HistoryLength SMALLINT NOT NULL,
    BrowserLanguage TEXT  NOT NULL,
    BrowserCountry TEXT  NOT NULL,
    SocialNetwork TEXT  NOT NULL,
    SocialAction TEXT  NOT NULL,
    HTTPError SMALLINT NOT NULL,
    SendTiming INTEGER NOT NULL,
    DNSTiming INTEGER NOT NULL,
    ConnectTiming INTEGER NOT NULL,
    ResponseStartTiming INTEGER NOT NULL,
    ResponseEndTiming INTEGER NOT NULL,
    FetchTiming INTEGER NOT NULL,
    SocialSourceNetworkID SMALLINT NOT NULL,
    SocialSourcePage TEXT  NOT NULL,
    ParamPrice BIGINT NOT NULL,
    ParamOrderID TEXT  NOT NULL,
    ParamCurrency TEXT  NOT NULL,
    ParamCurrencyID SMALLINT NOT NULL,
    OpenstatServiceName TEXT  NOT NULL,
    OpenstatCampaignID TEXT  NOT NULL,
    OpenstatAdID TEXT  NOT NULL,
    OpenstatSourceID TEXT  NOT NULL,
    UTMSource TEXT  NOT NULL,
    UTMMedium TEXT  NOT NULL,
    UTMCampaign TEXT  NOT NULL,
    UTMContent TEXT  NOT NULL,
    UTMTerm TEXT  NOT NULL,
    FromTag TEXT  NOT NULL,
    HasGCLID SMALLINT NOT NULL,
    RefererHash BIGINT NOT NULL,
    URLHash BIGINT NOT NULL,
    CLID INTEGER NOT NULL,
	payload jsonb NOT NULL
);

ALTER TABLE hit_compressed_pglz ALTER COLUMN FromTag SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN UTMTerm SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN UTMContent SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN UTMCampaign SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN UTMMedium SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN UTMSource SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN OpenstatSourceID SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN OpenstatAdID SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN OpenstatCampaignID SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN OpenstatServiceName SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN ParamCurrency SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN ParamOrderID SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN SocialSourcePage SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN SocialAction SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN SocialNetwork SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN BrowserCountry SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN BrowserLanguage SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN HitColor SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN OriginalURL SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN PageCharset SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN SearchPhrase SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN MobilePhoneModel SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN UserAgentMinor SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN FlashMinor2 SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN Referer SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN URL SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN Title SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN Params SET STORAGE main;
ALTER TABLE hit_compressed_pglz ALTER COLUMN payload SET STORAGE main;



create index idx_hit_compressed_eventtime on hit_compressed_lz4(eventtime DESC);
CREATE INDEX idx_hit_compressed_regid  on hit_compressed_lz4 (RegionID);
CREATE INDEX idx_hit_compressed_cid on hit_compressed_lz4 (counterid);
CREATE INDEX idx_hit_compressed_refresh on hit_compressed_lz4 (isrefresh, dontcounthits) where isrefresh <> 0 and dontcounthit <> 0;
CREATE INDEX idx_hit_compressed_userid on hit_compressed_lz4 (userid);
CREATE INDEX idx_hit_compressed_regionuser on hit_compressed_lz4 (RegionID,UserID);
CREATE INDEX idx_hit_compressed_search2 on hit_compressed_lz4 (searchphrase) WHERE searchphrase <> ''::text;
CREATE INDEX idx_hit_compressed_trgm_idx_url ON hit_compressed_lz4 USING gin (url gin_trgm_ops);



drop table hit_hyper_compressed;
CREATE TABLE hit_hyper_compressed
(
    WatchID BIGINT NOT NULL,
    JavaEnable SMALLINT NOT NULL,
    Title TEXT COMPRESSION LZ4 NOT NULL ,
    GoodEvent SMALLINT NOT NULL,
    EventTime TIMESTAMPTZ NOT NULL,
    EventDate Date NOT NULL,
    CounterID INTEGER NOT NULL,
    ClientIP INTEGER NOT NULL,
    RegionID INTEGER NOT NULL,
    UserID BIGINT NOT NULL,
    CounterClass SMALLINT NOT NULL,
    OS SMALLINT NOT NULL,
    UserAgent SMALLINT NOT NULL,
    URL TEXT COMPRESSION LZ4 NOT NULL,
    Referer TEXT COMPRESSION LZ4 NOT NULL,
    IsRefresh SMALLINT NOT NULL,
    RefererCategoryID SMALLINT NOT NULL,
    RefererRegionID INTEGER NOT NULL,
    URLCategoryID SMALLINT NOT NULL,
    URLRegionID INTEGER NOT NULL,
    ResolutionWidth SMALLINT NOT NULL,
    ResolutionHeight SMALLINT NOT NULL,
    ResolutionDepth SMALLINT NOT NULL,
    FlashMajor SMALLINT NOT NULL,
    FlashMinor SMALLINT NOT NULL,
    FlashMinor2 TEXT COMPRESSION LZ4 NOT NULL,
    NetMajor SMALLINT NOT NULL,
    NetMinor SMALLINT NOT NULL,
    UserAgentMajor SMALLINT NOT NULL,
    UserAgentMinor TEXT COMPRESSION LZ4 NOT NULL,
    CookieEnable SMALLINT NOT NULL,
    JavascriptEnable SMALLINT NOT NULL,
    IsMobile SMALLINT NOT NULL,
    MobilePhone SMALLINT NOT NULL,
    MobilePhoneModel TEXT COMPRESSION LZ4 NOT NULL,
    Params TEXT COMPRESSION LZ4 NOT NULL,
    IPNetworkID INTEGER NOT NULL,
    TraficSourceID SMALLINT NOT NULL,
    SearchEngineID SMALLINT NOT NULL,
    SearchPhrase TEXT COMPRESSION LZ4 NOT NULL,
    AdvEngineID SMALLINT NOT NULL,
    IsArtifical SMALLINT NOT NULL,
    WindowClientWidth SMALLINT NOT NULL,
    WindowClientHeight SMALLINT NOT NULL,
    ClientTimeZone SMALLINT NOT NULL,
    ClientEventTime TIMESTAMPTZ NOT NULL,
    SilverlightVersion1 SMALLINT NOT NULL,
    SilverlightVersion2 SMALLINT NOT NULL,
    SilverlightVersion3 INTEGER NOT NULL,
    SilverlightVersion4 SMALLINT NOT NULL,
    PageCharset TEXT COMPRESSION LZ4 NOT NULL,
    CodeVersion INTEGER NOT NULL,
    IsLink SMALLINT NOT NULL,
    IsDownload SMALLINT NOT NULL,
    IsNotBounce SMALLINT NOT NULL,
    FUniqID BIGINT NOT NULL,
    OriginalURL TEXT COMPRESSION LZ4 NOT NULL,
    HID INTEGER NOT NULL,
    IsOldCounter SMALLINT NOT NULL,
    IsEvent SMALLINT NOT NULL,
    IsParameter SMALLINT NOT NULL,
    DontCountHits SMALLINT NOT NULL,
    WithHash SMALLINT NOT NULL,
    HitColor CHAR COMPRESSION LZ4 NOT NULL,
    LocalEventTime TIMESTAMPTZ NOT NULL,
    Age SMALLINT NOT NULL,
    Sex SMALLINT NOT NULL,
    Income SMALLINT NOT NULL,
    Interests SMALLINT NOT NULL,
    Robotness SMALLINT NOT NULL,
    RemoteIP INTEGER NOT NULL,
    WindowName INTEGER NOT NULL,
    OpenerName INTEGER NOT NULL,
    HistoryLength SMALLINT NOT NULL,
    BrowserLanguage TEXT COMPRESSION LZ4 NOT NULL,
    BrowserCountry TEXT COMPRESSION LZ4 NOT NULL,
    SocialNetwork TEXT COMPRESSION LZ4 NOT NULL,
    SocialAction TEXT COMPRESSION LZ4 NOT NULL,
    HTTPError SMALLINT NOT NULL,
    SendTiming INTEGER NOT NULL,
    DNSTiming INTEGER NOT NULL,
    ConnectTiming INTEGER NOT NULL,
    ResponseStartTiming INTEGER NOT NULL,
    ResponseEndTiming INTEGER NOT NULL,
    FetchTiming INTEGER NOT NULL,
    SocialSourceNetworkID SMALLINT NOT NULL,
    SocialSourcePage TEXT COMPRESSION LZ4 NOT NULL,
    ParamPrice BIGINT NOT NULL,
    ParamOrderID TEXT COMPRESSION LZ4 NOT NULL,
    ParamCurrency TEXT COMPRESSION LZ4 NOT NULL,
    ParamCurrencyID SMALLINT NOT NULL,
    OpenstatServiceName TEXT COMPRESSION LZ4 NOT NULL,
    OpenstatCampaignID TEXT COMPRESSION LZ4 NOT NULL,
    OpenstatAdID TEXT COMPRESSION LZ4 NOT NULL,
    OpenstatSourceID TEXT COMPRESSION LZ4 NOT NULL,
    UTMSource TEXT COMPRESSION LZ4 NOT NULL,
    UTMMedium TEXT COMPRESSION LZ4 NOT NULL,
    UTMCampaign TEXT COMPRESSION LZ4 NOT NULL,
    UTMContent TEXT COMPRESSION LZ4 NOT NULL,
    UTMTerm TEXT COMPRESSION LZ4 NOT NULL,
    FromTag TEXT COMPRESSION LZ4 NOT NULL,
    HasGCLID SMALLINT NOT NULL,
    RefererHash BIGINT NOT NULL,
    URLHash BIGINT NOT NULL,
    CLID INTEGER NOT NULL,
	payload jsonb COMPRESSION LZ4 NOT NULL
);

ALTER TABLE hit_hyper_compressed ALTER COLUMN FromTag SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN UTMTerm SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN UTMContent SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN UTMCampaign SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN UTMMedium SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN UTMSource SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN OpenstatSourceID SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN OpenstatAdID SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN OpenstatCampaignID SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN OpenstatServiceName SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN ParamCurrency SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN ParamOrderID SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN SocialSourcePage SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN SocialAction SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN SocialNetwork SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN BrowserCountry SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN BrowserLanguage SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN HitColor SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN OriginalURL SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN PageCharset SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN SearchPhrase SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN MobilePhoneModel SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN UserAgentMinor SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN FlashMinor2 SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN Referer SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN URL SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN Title SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN Params SET STORAGE main;
ALTER TABLE hit_hyper_compressed ALTER COLUMN Payload SET STORAGE main;





SELECT create_hypertable('hit_hyper_compressed', 'eventtime', chunk_time_interval => INTERVAL '1 day');
After inserting data, check chunks with their sizes:


select * from chunks_detailed_size('hit_hyper_uncompressed');

select 	chunk_schema,
		chunk_name,
		pg_size_pretty(sum(table_bytes)) as table_size,
		pg_size_pretty(sum(index_bytes)) as index_size,
		pg_size_pretty(sum(toast_bytes)) as toast_size,
		pg_size_pretty(sum(total_bytes)) as total_size
from	
chunks_detailed_size('hit_hyper_compressed');


ALTER TABLE hit_hyper_compressed SET (timescaledb.compress, timescaledb.compress_orderby = 'counterid, eventdate, userid, eventtime')
SELECT add_compression_policy('hits', INTERVAL '3d')hit_hyper_uncompressed

SELECT compress_chunk(i, if_not_compressed => true)
    FROM show_chunks(
        'hit_hyper_compressed',
        2013-08-01 00:00:00,
        2013-07-01 00:00:00
    ) i;


View current compression policy

To view the compression policy that you've set:

SELECT * FROM timescaledb_information.jobs
  WHERE proc_name='policy_compression';


psql:index.sql:26: ERROR:  index row size 2904 exceeds btree version 4 maximum 2704 for index "idx_hit_compressed_url"



For more information, see the API reference for timescaledb_information.jobs.





The policy runs after 2

We are compressing data older than 3 days.

SELECT compress_chunk(i, if_not_compressed => true)
    FROM show_chunks(
        'hit_hyper_compressed',
        2013-07-29 00:00:00,
        2013-07-01 00:00:00
    ) i;



verify compression:

SELECT show_chunks('example', older_than => INTERVAL '3 days');


CREATE INDEX idx_hit_hyper_compressed_regid  on hit_hyper_compressed (RegionID);
CREATE INDEX idx_hit_hyper_compressed_cid on hit_hyper_compressed (counterid);
CREATE INDEX idx_hit_hyper_compressed_refresh on hit_hyper_compressed (isrefresh, dontcounthits) where isrefresh <> 0 and dontcounthit <> 0;
CREATE INDEX idx_hit_hyper_compressed_userid on hit_hyper_compressed (userid);
CREATE INDEX idx_hit_hyper_compressed_regionuser on hit_hyper_compressed (RegionID,UserID);
CREATE INDEX idx_hit_hyper_compressed_search2 on hit_hyper_compressed (searchphrase) WHERE searchphrase <> ''::text;
CREATE INDEX idx_hit_hyper_compressed_url on hit_hyper_compressed (url) WHERE url <> ''::text;
CREATE INDEX idx_hit_hyper_compressed_trgm_idx_url ON hit_hyper_compressed USING gin (url gin_trgm_ops);




ALTER TABLE test_main ALTER COLUMN FromTag SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN UTMTerm SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN UTMContent SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN UTMCampaign SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN UTMMedium SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN UTMSource SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN OpenstatSourceID SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN OpenstatAdID SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN OpenstatCampaignID SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN OpenstatServiceName SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN ParamCurrency SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN ParamOrderID SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN SocialSourcePage SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN SocialAction SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN SocialNetwork SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN BrowserCountry SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN BrowserLanguage SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN HitColor SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN OriginalURL SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN PageCharset SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN SearchPhrase SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN MobilePhoneModel SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN UserAgentMinor SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN FlashMinor2 SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN Referer SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN URL SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN Title SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN Params SET STORAGE main;
ALTER TABLE test_main ALTER COLUMN payload SET STORAGE main;



ALTER TABLE test_external ALTER COLUMN FromTag SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN UTMTerm SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN UTMContent SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN UTMCampaign SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN UTMMedium SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN UTMSource SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN OpenstatSourceID SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN OpenstatAdID SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN OpenstatCampaignID SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN OpenstatServiceName SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN ParamCurrency SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN ParamOrderID SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN SocialSourcePage SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN SocialAction SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN SocialNetwork SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN BrowserCountry SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN BrowserLanguage SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN HitColor SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN OriginalURL SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN PageCharset SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN SearchPhrase SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN MobilePhoneModel SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN UserAgentMinor SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN FlashMinor2 SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN Referer SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN URL SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN Title SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN Params SET STORAGE external;
ALTER TABLE test_external ALTER COLUMN payload SET STORAGE external;




Helper function for generating random jsonb string

drop function create_jsonb_random();
CREATE OR REPLACE FUNCTION create_jsonb_random() 
RETURNS json AS
$$
BEGIN
 RETURN json_build_object('payload', gen) from repeat('a', pow(4,floor(random() * 20 + 1))::int) gen;
END;
$$ LANGUAGE plpgsql;